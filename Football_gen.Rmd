---
title: "Football"
author: "Haddon"
date: "2022-10-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(reticulate)
library(stringr)
library(rvest)
library(data.table)
```

Scraping in R:
```{r}
links <- read.table("Game_Links_Home.txt", sep = "")

table_store <- list()
page <- list()
df_stats <- list()
df_scoreboard <- list()


for(i in 1:nrow(links)){
  page[[i]] <- read_html(as.character(links[i,1]))
  table_store[[i]] <- html_table(page[[i]])
  
}


for(i in 1:length(page)){
  
  #Transposing Data
  df_stats[[i]] <- transpose(data.frame(table_store[[i]][2]), make.names =  1)
  
  #Getting Score For Each Game
  df_scoreboard[[i]] <- table_store[[i]][1]
  
  #Adding Team Names to the Rows
  rownames(df_stats[[i]]) <- data.frame(df_scoreboard[[i]])$Var.1
  
  #Adding Final Score
  df_stats[[i]]$Score <- data.frame(df_scoreboard[[i]])$T
}
```


```{r}
df_stats
```


Generic Reformat of Data Passed to R:
```{r}
master_list <- df_stats
```

Changing string data to useful numeric data. Here we'll take anything that's in "x-y" format, where x and y are numeric and reformat them into a ratio. Also updating time of possesion to be minutes plus seconds as ratio of a minute.


```{r}
ratio_ESPN <- function(list){
    col_position <- c(2,3,6)
    
    for(i in 1:length(list)){
      
      
      # Getting Total Passing Attempts:
      
      list[[i]]$Pass_Att <- as.numeric(word(list[[i]][,6], start = 1, sep = "-"))
      
      # Getting Total Penalty Yards
      
      list[[i]]$Penalty_yrds <- as.numeric(word(list[[i]][,12], start = -1, sep = "-"))
      
      # Renaming Comp-Att to "Completion Percentage".
      colnames(list[[i]])[6] <- "Completion Percentage"
      
      # Getting Proportions for variables: 3rd Down Eff, 4th Down Eff, Completion.
       for(k in col_position){
        
          if(as.numeric(word(list[[i]][1,k], start = 1, sep = "-")[1]) == 0){
           list[[i]][1,k] <- 0
          }else{
           list[[i]][1,k] <- as.numeric(word(list[[i]][1,k], start = 1, sep = "-"))/
                            as.numeric(word(list[[i]][1,k], start = -1, sep = "-"))
          }
           
           
           
          if(as.numeric(as.numeric(word(list[[i]][1,k], start = 1, sep = "-"))[1]) == 0){
           list[[i]][2,k] <- 0
          }else{
           list[[i]][2,k] <- as.numeric(word(list[[i]][2,k], start = 1, sep = "-"))/
                             as.numeric(word(list[[i]][2,k], start = -1, sep = "-"))
        }
       } 
      
      # Changing Time of Possession to a Numeric Variable (in minutes):
      
        #Row 1
        list[[i]][1, 16] <- as.numeric(word(list[[i]][1,16], start = 1, sep = ":"))+
                            (as.numeric(word(list[[i]][1,16], start = -1, sep = ":"))/60)
        #Row 2
        list[[i]][2, 16] <- as.numeric(word(list[[i]][2,16], start = 1, sep = ":"))+
                            (as.numeric(word(list[[i]][2,16], start = -1, sep = ":"))/60)
                                            
    }
        return(list)
}
    


master_list <- ratio_ESPN(master_list)
```

Changing Select Variables to Numeric and Rounding
```{r}
for(i in 1:length(master_list)){
  master_list[[i]][,-12] <- as.numeric(unlist(master_list[[i]][,-12]))
}

for(i in 1:length(master_list)){
 master_list[[i]][-12] <- round(master_list[[i]][-12], digits = 4)
}

#Checking
master_list
```


Removing Penalties covariate which is displayed as a string so I can perform global row operations.
```{r}
for(i in 1:length(master_list)){
  master_list[[i]] <- master_list[[i]][,-15] 
}

for(i in 1:length(master_list)){
  master_list[[i]] <- master_list[[i]] %>% 
    select(-Penalties)
}

#Checking
master_list
```


Creating Dataset for Team of interest to perform models on. This will require creating new variables from each game result, and making them a row in the new dataset. Each row will represent team of interest's performance for a singular game.

```{r}

smush_ESPN <- function(list){
  
   Team_Stats <- matrix(NA, nrow = length(master_list), ncol = length(master_list[[1]]))
   
  
  for (i in 1:length(master_list)) {
    
    master_list[[i]][1,] <- -master_list[[i]][1,]
    
    Team_Stats[i,] <- matrix(colSums(master_list[[i]]), nrow = 1)
    
    Team_Stats <- data.frame(Team_Stats)
    
    colnames(Team_Stats) <- paste("diff", colnames(master_list[[i]]), sep = "\n")
    
   }
  
  return(Team_Stats)
  
}

smush_ESPN(master_list)


```
